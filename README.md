# Видео Загрузчик Бот

Telegram-бот, построенный на Java и Spring Boot, который скачивает видео с YouTube (включая Shorts) и VK с помощью [yt-dlp](https://github.com/yt-dlp/yt-dlp). Бот обрабатывает сообщения пользователей, содержащие URL видео, скачивает видео в формате MP4 (разрешение до 720p и размер до ~45 МБ), и сохраняет его локально в директории скачиваний. Отправка видео в чат отключена для избежания проблем с таймаутами или прокси. Фокус на надежном скачивании и логировании.

Проект контейнеризирован с помощью Docker. Файлы сохраняются в монтируемом volume (`./downloads`), а куки могут использоваться для аутентифицированных скачиваний из VK или YouTube Shorts.

## Возможности

- **Скачивание видео**: Поддержка YouTube, YouTube Shorts, VK и других источников, совместимых с yt-dlp.
- **Извлечение URL**: Автоматически обнаруживает HTTP/HTTPS URL из сообщений пользователей, очищает текст и обрабатывает их.
- **Ограничение размера**: Скачивает видео до ~45 МБ для совместимости с потенциальными лимитами.
- **Поддержка куки**: Использует `cookies.txt` для VK и YouTube Shorts, если файл существует в директории скачиваний.
- **Отладка**: Обширное логирование с сообщениями [DEBUG], отправляемыми пользователю, и выводом в консоль. Логи yt-dlp сохраняются в файлы.
- **Асинхронная обработка**: Использует сервис исполнителя для обработки скачиваний без блокировки основного потока.
- **Контейнеризация**: Работает в контейнере с предустановленными yt-dlp и FFmpeg. Включает docker-compose для простой настройки.
- **Постоянное хранение**: Скачанные видео и логи остаются на диске даже после ошибок.

## Требования

- Java 17 (JDK для разработки, JRE в Docker).
- Maven для сборки JAR.
- Docker и Docker Compose для контейнеризации.
- Токен и имя пользователя Telegram-бота (получите от [@BotFather](https://t.me/botfather)).
- yt-dlp (установлен в образе Docker).
- FFmpeg (установлен в образе Docker для объединения видео и аудио).
- Опционально: `cookies.txt` для аутентифицированных скачиваний (экспортируйте из браузера с помощью расширений вроде "Get cookies.txt LOCALLY").

## Структура проекта
video-loader-bot/
├── .env                  # Переменные окружения (например, токен Telegram)
├── .gitattributes        # Атрибуты Git
├── .gitignore            # Файл игнорирования Git
├── cookies.txt           # Опциональные куки для VK/YouTube (монтируется в /app/downloads)
├── docker-compose.yml    # Конфигурация Docker Compose
├── Dockerfile            # Файл сборки Docker
├── HELP.md               # Файл помощи Maven (автогенерируемый)
├── mvnw                  # Обертка Maven
├── mvnw.cmd              # Обертка Maven для Windows
├── pom.xml               # Файл проекта Maven
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/example/videoloaderbot/
│   │   │       └── MyTelegramBot.java  # Основной класс бота
│   │   └── resources/
│   │       └── application.properties  # Конфигурация Spring Boot
│   └── test/             # Исходники тестов (по умолчанию пусто)
├── target/               # Выход сборки (например, JAR-файл)
└── downloads/            # Монтируемый volume для видео, логов и куки


## Установка

### Локальная разработка (без Docker)

1. Клонируйте репозиторий:
   git clone https://github.com/yourusername/video-loader-bot.git
   cd video-loader-bot

2. Обновите `src/main/resources/application.properties` данными вашего бота Telegram:
   telegram.bot.token=ВАШ_ТОКЕН_БОТА
   telegram.bot.username=ВАШЕ_ИМЯ_БОТА

3. Соберите проект с помощью Maven:
   mvn clean package

4. Запустите JAR (убедитесь, что yt-dlp и FFmpeg установлены локально):
   java -jar target/video-loader-bot-0.0.1-SNAPSHOT.jar

5. Создайте директорию `downloads` в корне проекта для хранения видео.


### С Docker

1. Клонируйте репозиторий (как выше).

2. Создайте или обновите файл `.env` с учетными данными Telegram:
   TELEGRAM_BOT_TOKEN=ВАШ_ТОКЕН_БОТА
   TELEGRAM_BOT_USERNAME=ВАШЕ_ИМЯ_БОТА

3. Опционально: Подготовьте `cookies.txt` в корне проекта для аутентификации VK/YouTube.

4. Соберите и запустите с Docker Compose:
   docker-compose up --build
- Это соберет образ бота и смонтирует `./downloads` в `/app/downloads`.
- Просмотрите логи с помощью `docker logs video-downloader-bot`.

## Использование

1. Запустите бота (локально или в Docker).

2. В Telegram отправьте боту URL видео, например:
   https://www.youtube.com/watch?v=example или https://vk.com/video-123456_789012

3. Бот выполнит:
- Подтверждение сообщения.
- Извлечение и валидацию URL.
- Скачивание видео с помощью yt-dlp (с подменой user-agent и referer для надежности).
- Сохранение видео в `/app/downloads` (или `./downloads` на хосте).
- Логирование процесса и сохранение вывода yt-dlp в файл лога.
- Отправку сообщений о статусе скачивания (успех, ошибка, путь к файлу).

4. Для VK или YouTube Shorts, требующих аутентификации, поместите `cookies.txt` в `./downloads` (он будет смонтирован в контейнер). Видео сохраняется локально для дальнейшего использования.

## Конфигурация

- **Учетные данные Telegram**: Устанавливаются в `application.properties` или через переменные окружения в Docker.
- **Директория скачиваний**: `/app/downloads` в контейнере, монтируется в `./downloads` на хосте.
- **Опции yt-dlp**:
- Формат: Лучшее MP4 видео ≤720p + лучшее аудио.
- Максимальный размер: 45 МБ.
- Без плейлистов.
- Подробное логирование.
- **Прокси**: Установите `HTTP_PROXY` и `HTTPS_PROXY` в `docker-compose.yml`, если нужно.

## Устранение неисправностей

- **Ошибки yt-dlp**: Проверьте логи в `./downloads/yt-dlp-log_*.txt`. Общие проблемы: ограничения сети (используйте прокси), неверные URL или превышение размера.
- **Куки не работают**: Убедитесь, что `cookies.txt` в формате Netscape и правильно смонтирован. Протестируйте с `yt-dlp --cookies /app/downloads/cookies.txt URL`.
- **Проблемы с API Telegram**: Проверьте токен/имя пользователя. Включите отладочное логирование в `application.properties`.
- **Файл не скачивается**: Проверьте наличие yt-dlp и FFmpeg в контейнере, сетевые настройки.
- **Проблемы с Docker**: Убедитесь, что порты свободны, volume доступны для записи. Запустите `docker-compose logs` для деталей.

